---
title: "p8130_final_project"
author: "Qinyao Wu"
date: "12/6/2018"
output: html_document
---

```{r setup, include=FALSE}

#Install the packges.

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(faraway)
library(leaps)
library(caret)
library(boot)
library(broom)
```

```{r import_data}
#Import data
cancer_data = read_csv("./data/Cancer_Registry.csv") 
 
#Count na, modify the na table to show the variable with NAs. 
cancer_na = map_df(cancer_data, function(x) sum(is.na(x))) %>% data.frame() %>%
  t() %>% data.frame()

#Add column names.
colnames(cancer_na) = "na_counts"

#Make a table for na. 
cancer_na = cancer_na %>% mutate(variable_name = row.names(cancer_na)) %>% select(2, 1) %>%
  filter(na_counts > 0) %>% knitr::kable()
cancer_na

```

```{r}
#Tidy the data set. 
cancer_data_analysis = cancer_data %>% 
  janitor::clean_names() %>% 

  
  #Make income a dummy variable by divide up by mean of income. 
  mutate(med_income = as.numeric(med_income) ) %>% 
  mutate(income_cat = ifelse(med_income >= mean(med_income), 1, 0)) %>% 
  
  #Divide up ages by mean of age. 
  mutate(age_cat = ifelse(median_age >= mean(median_age), 1, 0)) %>%
  
  #remove variables with a lot of na, pct_employed16_over do not have a lot, so we decide to keep it. 
  select(-pct_some_col18_24, -pct_private_coverage_alone, -med_income) %>% 
  
    #remove unrelated variables
  select(-binned_inc) %>% 
 
  #Make the y at the first column. 
  select(target_death_rate, everything())

  rownames(cancer_data_analysis) = cancer_data_analysis$geography
  

 #Skim over all the variables.  
cancer_data_analysis %>% 
  select(-geography) %>% 

 skimr::skim()


#Look at the overall correlation. 
cancer_data_analysis %>% 
  select(-geography) %>% 
  cor() %>% 
  knitr::kable()




attach(cancer_data_analysis)

summary(cancer_data_analysis)
```


```{r}
#Choose variables we are interested in and the variables from primary literature.  

#Reasons for choosing these variables:

# compared the employed status
# compare the education status
# white has the largest percentage, so we decide to choose white.


cancer_s = cancer_data_analysis %>%
  select(target_death_rate, avg_ann_count, incidence_rate, pct_employed16_over, pct_unemployed16_over, age_cat, pct_private_coverage, pct_white, pct_hs25_over, pct_hs18_24, study_per_cap)

#Look at the covariance between the variables. 
cor(cancer_s) %>% knitr::kable()

#Look at the overall distribution and percentiles of the variables we choose.
skimr::skim(cancer_s)

cancer_s %>% 
  ggplot(aes(x = target_death_rate)) + 
    geom_histogram(aes(y = ..density..),  
                   binwidth = 2, colour = "black", fill = "white") +
    geom_density(alpha = .1) +
    labs(
    title = "Distribution of target death")

#Make a histogram set to show the normal distribution of the variables to decide whether transformation is required. 
cancer_s %>%
  select(-age_cat, -income_cat) %>%
  gather(measure, value) %>%
  ggplot(aes(value)) +
  facet_wrap(. ~ measure, scales = "free") +
  geom_histogram()


#Find the significant variables in each number of parameters. Used as a reference for later removal of variables. 
criterion_subset = regsubsets(target_death_rate ~ ., data = cancer_s, nvmax = 34)
   (rs = summary(criterion_subset))

par(mar = c(4,4,1,1))
par(mfrow = c(1,2))


#Only when the p equals to 9, Cp=8.76 < Parameter. As a result, we decide that the number of predictors would be 9-1 = 8 or 10-1 = 9. So we look back to the significance table and we found that only the study_per_cap is not significant and we decided to remove it. 

plot(2:11, rs$cp, xlab = "No of parameters", ylab = "Cp Statistic")
abline(0,1)

#And at parameter equals to 9, the adjusted r square value is highest. 

plot(2:11, rs$adjr2, xlab = "No of parameters", ylab = "Adj R2")


#So we decide this is our final model. 
cancer_lm = lm(target_death_rate ~ avg_ann_count + incidence_rate + pct_hs25_over + age_cat + pct_private_coverage + pct_white + pct_employed16_over + pct_hs18_24 + pct_unemployed16_over, data = cancer_s)

summary(cancer_lm)


```


###Model Diagnostic

```{r}
#Add the row names for the data set using the geography column. 
rownames(cancer_data_analysis) = cancer_data_analysis$geography

#Apply the model we built. 
cancer_lm = lm(target_death_rate ~ avg_ann_count + incidence_rate + pct_hs25_over + age_cat + pct_private_coverage + pct_white + pct_employed16_over + pct_hs18_24 + pct_unemployed16_over, data = cancer_s)

#Look at the studendized ourliers
stu_res = rstandard(cancer_lm)

outliers_y = stu_res[abs(stu_res) > 2.5]

#Make four plots to show whether the assumptions are met. 
par(mfrow = c(2,2))
plot(cancer_lm)

# 1000 might be an influential outlier. 
lev = hatvalues(cancer_lm)
lev[lev > 0.2]

#   a = cancer_data_analysis[-1000,]

#Calculate the DIFFITS to determine the outliers. 
diffits_data = dffits(cancer_lm) %>%
  data.frame()

colnames(diffits_data) = c("diffit")

diffits_data$county = rownames(cancer_data_analysis)


diffits_data %>%
  filter(diffit > 2*sqrt(9/3047))


```

